<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Транспортный билет</title>
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <style>
        :root {
            --text: #D4D4D4;
            --accent: #E21A1A;
            --border: #303030;
            --bg: #000;
            --input-bg: #1A1A1A;
            --gray: #787878;
            --light-gray: #303030;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        p { margin: 0; }

        .app__header {
            border-bottom: 1px solid var(--border);
            padding-top: 10px;
            flex-shrink: 0;
        }

        .effective {
            font-size: 20px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 25px;
        }

        .navbar {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .navbar span {
            font-size: 16px;
            font-weight: 500;
            padding: 0 13px 11px;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .navbar span.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        .navbar span svg path,
        .navbar span svg {
            fill: var(--text);
            stroke: var(--text);
        }

        .navbar span.active svg path,
        .navbar span.active svg {
            fill: var(--accent);
            stroke: var(--accent);
        }

        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .ticket__info,
        .control-content {
            padding: 15px 20px 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .control-content {
            display: none;
            text-align: center;
            padding: 20px;
            background: var(--bg);
        }

        .info__item {
            border-bottom: 1px solid var(--border);
            padding: 6px 0 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info__item:last-child {
            border-bottom: 0;
        }

        .image {
            min-width: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image svg {
            width: 24px;
            height: 24px;
            display: block;
        }

        .data p {
            font-size: 16px;
            color: var(--gray);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .data div {
            font-size: 22px;
            color: var(--text);
            font-weight: 500;
        }

        .qr-container {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 10px;
            display: inline-block;
        }

        #qrcode {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .ticket-number {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            color: var(--text);
        }

        .button__wrapper {
            padding: 10px 20px 30px;
            background: var(--input-bg);
            flex-shrink: 0;
        }

        .button__wrapper button {
            padding: 10px 20px;
            color: #fff;
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 48px;
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            background: var(--accent);
            border: none;
            outline: none;
            cursor: pointer;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="app__header">
        <div class="effective">Действует: <span id="timer">15 сек.</span></div>
        <div class="navbar">
            <span class="active" id="ticket-tab">
                <svg width="28" height="30" viewBox="0 0 28 30"><path d="M17.5 0H3.5C2.57174 0 1.6815 0.371848 1.02513 1.03374..."/></svg>
                <b id="order-id">867 291 334</b>
            </span>
            <span id="control-tab">
                <svg width="29" height="32" viewBox="0 0 29 32"><path d="M4.08334 4.48759C4.08334 1.94312..."/></svg>
                Контроль
            </span>
        </div>
    </div>

    <div class="content-area">
        <div id="ticket-content" class="ticket__info">
            <div class="info__item">
                <div class="image"><svg width="29" height="32"><path d="M4.08334 4.48759..."/></svg></div>
                <div class="data">
                    <p>Перевозчик</p>
                    <div id="carrier">ИП Долгушин Д.Г.</div>
                </div>
            </div>
            <div class="info__item">
                <div class="image"><svg width="30" height="30"><path d="M28.4962 8.9625..."/></svg></div>
                <div class="data">
                    <p>Маршрут</p>
                    <div id="route">пос.Таймир-мкрн. Тихие зори</div>
                </div>
            </div>
            <div class="info__item">
                <div class="image"><svg width="26" height="30"><path d="M15.6 19.2..."/></svg></div>
                <div class="data">
                    <p>Стоимость</p>
                    <div id="price">1 шт., Полный 44.00 ₽</div>
                </div>
            </div>
            <div class="info__item">
                <div class="image"><svg width="27" height="30"><path d="M24 27H3V10.5..."/></svg></div>
                <div class="data">
                    <p>Дата покупки</p>
                    <div id="date">12 мая 2024 г.</div>
                </div>
            </div>
            <div class="info__item">
                <div class="image"><svg width="31" height="31"><path d="M0.740005 15.2166..."/></svg></div>
                <div class="data">
                    <p>Время покупки:</p>
                    <div id="time">12:38</div>
                </div>
            </div>
        </div>

        <div id="control-content" class="control-content">
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <div class="ticket-number">№ <span id="control-ticket-number"></span></div>
        </div>
    </div>

    <div class="button__wrapper">
        <button id="close-button">закрыть</button>
    </div>

    <script>
        // Telegram Mini App
        const tg = Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // Получение параметра из URL
        const getParam = name => new URLSearchParams(window.location.search).get(name);

        // Парсинг данных
        const data = getParam('data');
        const ticket = data ? JSON.parse(atob(data)) : null;

        if (!ticket) {
            document.body.innerHTML = '<p>Данные билета не предоставлены.</p>';
            setTimeout(() => tg.close(), 3000);
            throw new Error();
        }

        // Форматирование номера
        const formatNum = num => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        const ticketNum = formatNum(ticket.number);

        // Заполнение полей
        Object.entries({
            'order-id': ticketNum,
            'carrier': ticket.carrier,
            'route': ticket.route_name,
            'bus': ticket.bus_number,
            'price': `${ticket.quantity} шт., Полный ${ticket.total_price},00 ₽`,
            'date': ticket.purchase_date,
            'time': ticket.purchase_time,
            'control-ticket-number': ticketNum
        }).forEach(([id, val]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        });

        // Переключение вкладок
        const showTab = (tab) => {
            document.getElementById('ticket-content').style.display = tab === 'ticket' ? 'block' : 'none';
            document.getElementById('control-content').style.display = tab === 'control' ? 'block' : 'none';
            document.getElementById('ticket-tab').classList.toggle('active', tab === 'ticket');
            document.getElementById('control-tab').classList.toggle('active', tab === 'control');
        };

        document.getElementById('ticket-tab').onclick = () => showTab('ticket');
        document.getElementById('control-tab').onclick = () => {
            showTab('control');
            if (!document.getElementById('qrcode').firstChild) {
                new QRCode(document.getElementById('qrcode'), {
                    text: ticket.number.toString(),
                    width: 200,
                    height: 200,
                    colorDark: "#000",
                    colorLight: "#fff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        };

        // Таймер
        const timerEl = document.getElementById('timer');
        let timeLeft = 15;
        const countdown = setInterval(() => {
            timerEl.textContent = `${timeLeft--} сек.`;
            if (timeLeft < 0) {
                clearInterval(countdown);
                tg.close();
            }
        }, 1000);

        // Кнопка закрытия
        document.getElementById('close-button').onclick = () => tg.close();
    </script>
</body>
</html>
